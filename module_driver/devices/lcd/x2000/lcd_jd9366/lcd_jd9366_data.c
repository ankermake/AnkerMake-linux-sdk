#include <linux/delay.h>
#include <linux/gpio.h>
#include <linux/module.h>
#include <utils/gpio.h>

#include <fb/lcdc_data.h>
#include <mipi_dsi/jz_mipi_dsi.h>


int gpio_lcd_power_en = -1; // GPIO_PB(8)
int gpio_lcd_rst = -1; // GPIO_PB(21)
int gpio_lcd_backlight_en = -1; // GPIO_PC(8)

module_param_gpio(gpio_lcd_power_en, 0644);
module_param_gpio(gpio_lcd_rst, 0644);
module_param_gpio(gpio_lcd_backlight_en, 0644);

static struct dsi_cmd_packet jd9366_cmd_list[] =
{
    {0x15, 0xE0,0x00},

    //--- PASSWORD  ----//

    {0x15, 0xE1,0x93},
    {0x15, 0xE2,0x65},
    {0x15, 0xE3,0xF8},
    {0x15, 0x80,0x01},

    //Page0

    {0x15, 0xE0,0x00},
    {0x15, 0x70,0x10},	//DC0,DC1
    {0x15, 0x71,0x13},	//DC2,DC3
    {0x15, 0x72,0x06},	//DC7

    //--- Page4  ----//

    {0x15, 0xE0,0x04},
    {0x15, 0x2D,0x03},  //0X
    {0x15, 0x09,0x14},

    //--- Page1  ----//
    {0x15, 0xE0,0x01},
    {0x15, 0x55,0x02},

    // {0x15,0x4A,0x35},

    //Set VCOM
    {0x15, 0x00,0x00},
    {0x15, 0x01,0xB6},

    //Set VCOM_Reverse

    {0x15, 0x03,0x00},
    {0x15, 0x04,0xA0},

    //Set Gamma Power, VGMP,VGMN,VGSP,VGSN

    {0x15, 0x17,0x00},
    {0x15, 0x18,0xB1},
    {0x15, 0x19,0x01},
    {0x15, 0x1A,0x00},
    {0x15, 0x1B,0xB1},  //VGMN=0
    {0x15, 0x1C,0x01},

    //Set Gate Power

    {0x15, 0x1F,0x3E},     //VGH_R  = 15V
    {0x15, 0x20,0x2D},     //VGL_R  = -12V
    {0x15, 0x21,0x2D},     //VGL_R2 = -12V
    {0x15, 0x22,0x0E},     //PA[6]=0, PA[5]=0, PA[4]=0, PA[0]=0
    {0x15, 0x35,0x0F},

    {0x15, 0x37,0x19},	//SS=1,BGR=1

    {0x15, 0x38,0x05},	//JDT=101 zigzag inversion
    {0x15, 0x39,0x08},	//RGB_N_EQ1, modify 20140806
    {0x15, 0x3A,0x12},	//RGB_N_EQ2, modify 20140806
    {0x15, 0x3C,0x78},	//SET EQ3 for TE_H
    {0x15, 0x3E,0x80},	//SET CHGEN_OFF, modify 20140806
    {0x15, 0x3F,0x80},	//SET CHGEN_OFF2, modify 20140806

    {0x15, 0x40,0x06},	//RSO=800 RGB
    {0x15, 0x41,0xA0},	//LN=640->1280 line
    {0x15, 0x4B,0x00},

    {0x15, 0x55,0x01},	//DCDCM=0001, JD PWR_IC
    {0x15, 0x56,0x01},
    {0x15, 0x57,0x69},
    {0x15, 0x58,0x0A},
    {0x15, 0x59,0x0A},	//VCL = -2.9V
    {0x15, 0x5A,0x28},	//VGH = 19V
    {0x15, 0x5B,0x19},	//VGL = -11V

    {0x15, 0x5D,0x7F}, //18
    {0x15, 0x5E,0x72}, //17
    {0x15, 0x5F,0x67}, //16
    {0x15, 0x60,0x5F}, //15
    {0x15, 0x61,0x5F}, //14
    {0x15, 0x62,0x51}, //13
    {0x15, 0x63,0x58}, //12
    {0x15, 0x64,0x44}, //11
    {0x15, 0x65,0x5C}, //10
    {0x15, 0x66,0x5A}, //9
    {0x15, 0x67,0x58}, //8
    {0x15, 0x68,0x74}, //7
    {0x15, 0x69,0x5D}, //6
    {0x15, 0x6A,0x5F}, //5
    {0x15, 0x6B,0x4D}, //4
    {0x15, 0x6C,0x45}, //3
    {0x15, 0x6D,0x36}, //2
    {0x15, 0x6E,0x24}, //1
    {0x15, 0x6F,0x0A}, //0
    {0x15, 0x70,0x7F}, //18
    {0x15, 0x71,0x72}, //17
    {0x15, 0x72,0x67}, //16
    {0x15, 0x73,0x5F}, //15
    {0x15, 0x74,0x5F}, //14
    {0x15, 0x75,0x51}, //13
    {0x15, 0x76,0x58}, //12
    {0x15, 0x77,0x44}, //11
    {0x15, 0x78,0x5C}, //10
    {0x15, 0x79,0x5A}, //9
    {0x15, 0x7A,0x58}, //8
    {0x15, 0x7B,0x74}, //7
    {0x15, 0x7C,0x5D}, //6
    {0x15, 0x7D,0x5F}, //5
    {0x15, 0x7E,0x4D}, //4
    {0x15, 0x7F,0x45}, //3
    {0x15, 0x80,0x36}, //2
    {0x15, 0x81,0x24}, //1
    {0x15, 0x82,0x0A}, //0

//page 2
    {0x15, 0xE0,0x02},

    {0x15, 0x00,0x47},
    {0x15, 0x01,0x47},
    {0x15, 0x02,0x45},
    {0x15, 0x03,0x45},
    {0x15, 0x04,0x4B},
    {0x15, 0x05,0x4B},
    {0x15, 0x06,0x49},
    {0x15, 0x07,0x49},
    {0x15, 0x08,0x41},
    {0x15, 0x09,0x1F},
    {0x15, 0x0A,0x1F},
    {0x15, 0x0B,0x1F},
    {0x15, 0x0C,0x1F},
    {0x15, 0x0D,0x1F},
    {0x15, 0x0E,0x1F},
    {0x15, 0x0F,0x43},
    {0x15, 0x10,0x1F},
    {0x15, 0x11,0x1F},
    {0x15, 0x12,0x1F},
    {0x15, 0x13,0x1F},
    {0x15, 0x14,0x1F},
    {0x15, 0x15,0x1F},

    {0x15, 0x16,0x46},
    {0x15, 0x17,0x46},
    {0x15, 0x18,0x44},
    {0x15, 0x19,0x44},
    {0x15, 0x1A,0x4A},
    {0x15, 0x1B,0x4A},
    {0x15, 0x1C,0x48},
    {0x15, 0x1D,0x48},
    {0x15, 0x1E,0x40},
    {0x15, 0x1F,0x1F},
    {0x15, 0x20,0x1F},
    {0x15, 0x21,0x1F},
    {0x15, 0x22,0x1F},
    {0x15, 0x23,0x1F},
    {0x15, 0x24,0x1F},
    {0x15, 0x25,0x42},
    {0x15, 0x26,0x1F},
    {0x15, 0x27,0x1F},
    {0x15, 0x28,0x1F},
    {0x15, 0x29,0x1F},
    {0x15, 0x2A,0x1F},
    {0x15, 0x2B,0x1F},

    {0x15, 0x2C,0x11},
    {0x15, 0x2D,0x0F},
    {0x15, 0x2E,0x0D},
    {0x15, 0x2F,0x0B},
    {0x15, 0x30,0x09},
    {0x15, 0x31,0x07},
    {0x15, 0x32,0x05},
    {0x15, 0x33,0x18},
    {0x15, 0x34,0x17},
    {0x15, 0x35,0x1F},
    {0x15, 0x36,0x01},
    {0x15, 0x37,0x1F},
    {0x15, 0x38,0x1F},
    {0x15, 0x39,0x1F},
    {0x15, 0x3A,0x1F},
    {0x15, 0x3B,0x1F},
    {0x15, 0x3C,0x1F},
    {0x15, 0x3D,0x1F},
    {0x15, 0x3E,0x1F},
    {0x15, 0x3F,0x13},
    {0x15, 0x40,0x1F},
    {0x15, 0x41,0x1F},

    {0x15, 0x42,0x10},
    {0x15, 0x43,0x0E},
    {0x15, 0x44,0x0C},
    {0x15, 0x45,0x0A},
    {0x15, 0x46,0x08},
    {0x15, 0x47,0x06},
    {0x15, 0x48,0x04},
    {0x15, 0x49,0x18},
    {0x15, 0x4A,0x17},
    {0x15, 0x4B,0x1F},
    {0x15, 0x4C,0x00},
    {0x15, 0x4D,0x1F},
    {0x15, 0x4E,0x1F},
    {0x15, 0x4F,0x1F},
    {0x15, 0x50,0x1F},
    {0x15, 0x51,0x1F},
    {0x15, 0x52,0x1F},
    {0x15, 0x53,0x1F},
    {0x15, 0x54,0x1F},
    {0x15, 0x55,0x12},
    {0x15, 0x56,0x1F},
    {0x15, 0x57,0x1F},

    {0x15, 0x58,0x40},
    {0x15, 0x59,0x00},
    {0x15, 0x5A,0x00},
    {0x15, 0x5B,0x30},
    {0x15, 0x5C,0x03},
    {0x15, 0x5D,0x30},
    {0x15, 0x5E,0x01},
    {0x15, 0x5F,0x02},
    {0x15, 0x60,0x00},
    {0x15, 0x61,0x01},
    {0x15, 0x62,0x02},
    {0x15, 0x63,0x03},
    {0x15, 0x64,0x6B},
    {0x15, 0x65,0x00},
    {0x15, 0x66,0x00},
    {0x15, 0x67,0x73},
    {0x15, 0x68,0x05},
    {0x15, 0x69,0x06},
    {0x15, 0x6A,0x6B},
    {0x15, 0x6B,0x08},
    {0x15, 0x6C,0x00},
    {0x15, 0x6D,0x0A},
    {0x15, 0x6E,0x0A},
    {0x15, 0x6F,0x88},
    {0x15, 0x70,0x00},
    {0x15, 0x71,0x00},
    {0x15, 0x72,0x06},
    {0x15, 0x73,0x7B},
    {0x15, 0x74,0x00},
    {0x15, 0x75,0x07},
    {0x15, 0x76,0x00},
    {0x15, 0x77,0x5D},
    {0x15, 0x78,0x17},
    {0x15, 0x79,0x1F},
    {0x15, 0x7A,0x00},
    {0x15, 0x7B,0x00},
    {0x15, 0x7C,0x00},
    {0x15, 0x7D,0x03},
    {0x15, 0x7E,0x7B},

    //Page1

    {0x15, 0xE0,0x01},
    {0x15, 0x0E,0x01},	//00\BE\CD\CAǲ\BB\BF\D8\D6ƣ\AC//01\BE\CD\CAǿ\D8\D6ƣ\AC//LEDON output VCSW2
    // {0x15,0x4A,0x35},

    //Page3

    {0x15, 0xE0,0x03},
    {0x15, 0x98,0x3F},	//From 2E to 2F, LED_VOL

    //Page4

    {0x15, 0xE0,0x04},
    {0x15, 0x09,0x10},
    {0x15, 0x2B,0x2B},
    {0x15, 0x2E,0x44},

    //Page0

    {0x15, 0xE0,0x00},
    {0x15, 0xE6,0x02},
    {0x15, 0xE7,0x02},

};

static void jd9366_init(void)
{
    int i;

    struct dsi_cmd_packet jd9366_sleep_out = {0x05, 0x11, 0x00};
    struct dsi_cmd_packet jd9366_display_on = {0x05, 0x29, 0x00};

    for (i = 0; i < ARRAY_SIZE(jd9366_cmd_list); i++) {
        dsi_write_cmd(&jd9366_cmd_list[i]);
    }

    dsi_write_cmd(&jd9366_sleep_out);
    msleep(120);
    dsi_write_cmd(&jd9366_display_on);
    msleep(10);

}

static inline int m_gpio_request(int gpio, const char *name)
{
    if (gpio < 0)
        return 0;

    int ret = gpio_request(gpio, name);
    if (ret) {
        char buf[20];
        printk(KERN_ERR "ma0060: failed to request %s: %s\n", name, gpio_to_str(gpio, buf));
        return ret;
    }

    return 0;
}

static inline void m_gpio_free(int gpio)
{
    if (gpio >= 0)
        gpio_free(gpio);
}


static inline void m_gpio_direction_output(int gpio, int value)
{
    if (gpio >= 0) {
        gpio_direction_output(gpio, value);
    }
}

static int jd9366_power_on(struct lcdc *lcdc)
{
    m_gpio_direction_output(gpio_lcd_power_en, 0);
    m_gpio_direction_output(gpio_lcd_backlight_en, 1);
    msleep(5);

    m_gpio_direction_output(gpio_lcd_rst, 1);
    msleep(10);
    m_gpio_direction_output(gpio_lcd_rst, 0);
    msleep(10);
    m_gpio_direction_output(gpio_lcd_rst, 1);
    msleep(10);

    return 0;
}

static int jd9366_power_off(struct lcdc *lcdc)
{
    m_gpio_direction_output(gpio_lcd_rst, 0);
    msleep(120);
    m_gpio_direction_output(gpio_lcd_power_en, 1);

    m_gpio_direction_output(gpio_lcd_backlight_en, 0);

    return 0;
}


static struct lcdc_data lcdc_data = {
    .name = "jd9366",
    .refresh = 60,
    .xres = 800,
    .yres = 1280,
    .pixclock = 0, // 自动计算
    .left_margin = 20,
    .right_margin = 32,
    .upper_margin = 4,
    .lower_margin = 8,
    .hsync_len = 20,
    .vsync_len = 4,

    .fb_fmt = fb_fmt_ARGB8888,
    .lcd_mode = TFT_MIPI,
    .out_format = OUT_FORMAT_RGB888,

    .mipi = {
        .num_of_lanes = 2,
        .virtual_channel = 0,
        .color_coding = COLOR_CODE_24BIT,
        .data_en_polarity = AT_RISING_EDGE,
        .byte_clock = 0,
        .max_hs_to_lp_cycles = 100,
        .max_lp_to_hs_cycles = 40,
        .max_bta_cycles = 4095,
        .color_mode_polarity = AT_RISING_EDGE,
        .shut_down_polarity = AT_RISING_EDGE,
        .video_mode = VIDEO_BURST_WITH_SYNC_PULSES,

        .hsync_active_level = AT_HIGH_LEVEL,
        .vsync_active_level = AT_HIGH_LEVEL,

    },
    .height = 184,
    .width = 114,

    .power_on = jd9366_power_on,
    .power_off = jd9366_power_off,
    .lcd_init = jd9366_init,
};

static int lcd_jd9366_init(void)
{
    int ret;

    ret = m_gpio_request(gpio_lcd_power_en, "gpio_lcd_power_en");
    if(ret)
        return -1;

    ret = m_gpio_request(gpio_lcd_rst, "gpio_lcd_rst");
    if (ret)
        goto rst_err;

    ret = m_gpio_request(gpio_lcd_backlight_en, "gpio_lcd_backlight_en");
    if(ret)
        goto backlight_err;

    ret = jzfb_register_lcd(&lcdc_data);
    if (ret < 0) {
        goto register_err;
    }

    return 0;

register_err:
    gpio_free(gpio_lcd_backlight_en);
backlight_err:
    gpio_free(gpio_lcd_rst);
rst_err:
    gpio_free(gpio_lcd_power_en);
    return -1;
}


static void lcd_jd9366_exit(void)
{
    jzfb_unregister_lcd(&lcdc_data);

    m_gpio_free(gpio_lcd_backlight_en);
    m_gpio_free(gpio_lcd_rst);
    m_gpio_free(gpio_lcd_power_en);
}


module_init(lcd_jd9366_init);
module_exit(lcd_jd9366_exit);

MODULE_DESCRIPTION("Ingenic Soc jd9366_lcd driver");
MODULE_LICENSE("GPL");