#include <linux/delay.h>
#include <linux/gpio.h>
#include <linux/module.h>
#include <utils/gpio.h>

#include <fb/lcdc_data.h>
#include <mipi_dsi/jz_mipi_dsi.h>
#include <linux/regulator/consumer.h>


int gpio_lcd_power_en = -1; // GPIO_PC(3)
int gpio_lcd_rst = -1; // GPIO_PC(4)
int gpio_lcd_backlight_en = -1; // -1
static char *gpio_lcd_regulator_name = "";

module_param_gpio(gpio_lcd_power_en, 0644);
module_param_gpio(gpio_lcd_rst, 0644);
module_param_gpio(gpio_lcd_backlight_en, 0644);
module_param(gpio_lcd_regulator_name, charp, 0644);

static struct regulator *fw050_regulator = NULL;

static struct dsi_cmd_packet fw050_cmd_list[] = {
	{0x39, 0x04, 0x00, (uint8_t[]){0xFF, 0x98, 0x81, 0x03}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x01, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x02, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x03, 0x73}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x04, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x05, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x06, 0x0A}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x07, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x08, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x09, 0x01}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x0A, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x0B, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x0C, 0x01}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x0D, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x0E, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x0F, 0x1D}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x10, 0x1D}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x11, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x12, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x13, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x14, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x15, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x16, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x17, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x18, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x19, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x1A, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x1B, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x1C, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x1D, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x1E, 0x40}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x1F, 0x80}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x20, 0x06}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x21, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x22, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x23, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x24, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x25, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x26, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x27, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x28, 0x33}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x29, 0x03}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x2A, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x2B, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x2C, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x2D, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x2E, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x2F, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x30, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x31, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x32, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x33, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x34, 0x04}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x35, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x36, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x37, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x38, 0x3C}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x39, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x3A, 0x40}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x3B, 0x40}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x3C, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x3D, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x3E, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x3F, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x40, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x41, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x42, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x43, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x44, 0x00}},

	{0x39, 0x02, 0x00, (uint8_t[]){0x50, 0x01}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x51, 0x23}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x52, 0x45}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x53, 0x67}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x54, 0x89}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x55, 0xAB}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x56, 0x01}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x57, 0x23}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x58, 0x45}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x59, 0x67}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x5A, 0x89}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x5B, 0xAB}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x5C, 0xCD}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x5D, 0xEF}},

	{0x39, 0x02, 0x00, (uint8_t[]){0x5E, 0x11}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x5F, 0x01}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x60, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x61, 0x15}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x62, 0x14}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x63, 0x0E}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x64, 0x0F}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x65, 0x0C}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x66, 0x0D}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x67, 0x06}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x68, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x69, 0x07}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x6A, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x6B, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x6C, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x6D, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x6E, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x6F, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x70, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x71, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x72, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x73, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x74, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x75, 0x01}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x76, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x77, 0x14}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x78, 0x15}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x79, 0x0E}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x7A, 0x0F}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x7B, 0x0C}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x7C, 0x0D}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x7D, 0x06}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x7E, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x7F, 0x07}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x80, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x81, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x82, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x83, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x84, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x85, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x86, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x87, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x88, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x89, 0x02}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x8A, 0x02}},
	{0x39, 0x04, 0x00, (uint8_t[]){0xFF, 0x98, 0x81, 0x04}},

	{0x39, 0x02, 0x00, (uint8_t[]){0x00, 0x80}}, //set 2 line mode

	{0x39, 0x02, 0x00, (uint8_t[]){0x6C, 0x15}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x6E, 0x2A}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x6F, 0x33}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x8D, 0x14}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x87, 0xBA}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x26, 0x76}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xB2, 0xD1}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xB5, 0x06}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x3A, 0x24}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x35, 0x1F}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x32, 0x05}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x33, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x7A, 0x0F}},
	{0x39, 0x04, 0x00, (uint8_t[]){0xFF, 0x98, 0x81, 0x01}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x22, 0x0A}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x31, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x53, 0x9c}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x55, 0x9c}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xB7, 0x03}},/*software set lansel pin */

	{0x39, 0x02, 0x00, (uint8_t[]){0x50, 0xA0}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x51, 0xA0}},

	{0x39, 0x02, 0x00, (uint8_t[]){0x60, 0x22}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x61, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x62, 0x19}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x63, 0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA0, 0x08}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA1, 0x19}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA2, 0x20}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA3, 0x12}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA4, 0x13}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA5, 0x24}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA6, 0x19}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA7, 0x19}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA8, 0x6b}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xA9, 0x1a}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xAA, 0x27}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xAB, 0x62}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xAC, 0x18}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xAD, 0x15}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xAE, 0x4c}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xAF, 0x22}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xB0, 0x25}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xB1, 0x5b}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xB2, 0x6f}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xB3, 0x39}},

	{0x39, 0x02, 0x00, (uint8_t[]){0xC0, 0x08}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xC1, 0x0d}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xC2, 0x19}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xC3, 0x0C}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xC4, 0x0c}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xC5, 0x1F}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xC6, 0x13}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xC7, 0x1a}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xC8, 0x5d}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xC9, 0x1b}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xCA, 0x26}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xCB, 0x5b}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xCC, 0x19}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xCD, 0x18}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xCE, 0x4C}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xCF, 0x22}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xD0, 0x2d}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xD1, 0x5D}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xD2, 0x6b}},
	{0x39, 0x02, 0x00, (uint8_t[]){0xD3, 0x39}},

	{0x39, 0x04, 0x00, (uint8_t[]){0xFF, 0x98, 0x81, 0x00}},
};

static void fw050_init(void)
{
    int i;
    struct dsi_cmd_packet fw050_sleep_out = {0x05, 0x11, 0x00};
    struct dsi_cmd_packet fw050_display_on = {0x05, 0x29, 0x00};

    for (i = 0; i < ARRAY_SIZE(fw050_cmd_list); i++) {
        dsi_write_cmd(&fw050_cmd_list[i]);
    }

    dsi_write_cmd(&fw050_sleep_out);
    msleep(120);
    dsi_write_cmd(&fw050_display_on);
    msleep(5);
}

static inline int m_gpio_request(int gpio, const char *name)
{
    if (gpio < 0)
        return 0;

    int ret = gpio_request(gpio, name);
    if (ret) {
        char buf[20];
        printk(KERN_ERR "fw050: failed to request %s: %s\n", name, gpio_to_str(gpio, buf));
        return ret;
    }

    return 0;
}

static inline void m_gpio_free(int gpio)
{
    if (gpio >= 0)
        gpio_free(gpio);
}


static inline void m_gpio_direction_output(int gpio, int value)
{
    if (gpio >= 0) {
        gpio_direction_output(gpio, value);
    }
}

static int fw050_power_on(struct lcdc *lcdc)
{
    if (fw050_regulator)
        regulator_enable(fw050_regulator);

    m_gpio_direction_output(gpio_lcd_power_en, 0);
    m_gpio_direction_output(gpio_lcd_backlight_en, 1);
    msleep(50);

    m_gpio_direction_output(gpio_lcd_rst, 1);
    msleep(30);
    m_gpio_direction_output(gpio_lcd_rst, 0);
    msleep(10);
    m_gpio_direction_output(gpio_lcd_rst, 1);
    msleep(120);

    return 0;
}

static int fw050_power_off(struct lcdc *lcdc)
{
    m_gpio_direction_output(gpio_lcd_power_en, 0);

    m_gpio_direction_output(gpio_lcd_backlight_en, 0);

    if (fw050_regulator)
        regulator_disable(fw050_regulator);

    return 0;
}


static struct lcdc_data lcdc_data = {
    .name = "fw050",
    .refresh = 60,
    .xres = 720,
    .yres = 1280,
    .pixclock = 0, // 自动计算
    .left_margin = 120,
    .right_margin = 100,
    .upper_margin = 25,
    .lower_margin = 20,
    .hsync_len = 10,
    .vsync_len = 10,

    .fb_fmt = fb_fmt_ARGB8888,
    .lcd_mode = TFT_MIPI,
    .out_format = OUT_FORMAT_RGB888,

    .mipi = {
        .num_of_lanes = 2,
        .virtual_channel = 0,
        .color_coding = COLOR_CODE_24BIT,
        .data_en_polarity = AT_RISING_EDGE,
        .byte_clock = 0,
        .max_hs_to_lp_cycles = 100,
        .max_lp_to_hs_cycles = 40,
        .max_bta_cycles = 4095,
        .color_mode_polarity = AT_RISING_EDGE,
        .shut_down_polarity = AT_RISING_EDGE,
        .video_mode = VIDEO_BURST_WITH_SYNC_PULSES,

        .hsync_active_level = AT_HIGH_LEVEL,
        .vsync_active_level = AT_HIGH_LEVEL,
    },
    .height = 110,
    .width = 62,

    .power_on = fw050_power_on,
    .power_off = fw050_power_off,
    .lcd_init = fw050_init,
};

static int lcd_fw050_init(void)
{
    int ret;

    if (strcmp("-1", gpio_lcd_regulator_name) && strlen(gpio_lcd_regulator_name)) {
        fw050_regulator = regulator_get(NULL, gpio_lcd_regulator_name);
        if(!fw050_regulator) {
            printk(KERN_ERR "lcd_regulator get err!\n");
            return -EINVAL;
        }
    }

    ret = m_gpio_request(gpio_lcd_power_en, "gpio_lcd_power_en");
    if(ret)
        goto power_on_err;

    ret = m_gpio_request(gpio_lcd_rst, "gpio_lcd_rst");
    if (ret)
        goto rst_err;

    ret = m_gpio_request(gpio_lcd_backlight_en, "gpio_lcd_backlight_en");
    if(ret)
        goto backlight_err;

    ret = jzfb_register_lcd(&lcdc_data);
    if (ret < 0) {
        goto register_err;
    }

    return 0;

register_err:
    m_gpio_free(gpio_lcd_backlight_en);
backlight_err:
    m_gpio_free(gpio_lcd_rst);
rst_err:
    m_gpio_free(gpio_lcd_power_en);
power_on_err:
    if (fw050_regulator)
        regulator_put(fw050_regulator);
    return -1;
}


static void lcd_fw050_exit(void)
{
    jzfb_unregister_lcd(&lcdc_data);

    if(fw050_regulator)
        regulator_put(fw050_regulator);

    m_gpio_free(gpio_lcd_backlight_en);
    m_gpio_free(gpio_lcd_rst);
    m_gpio_free(gpio_lcd_power_en);
}


module_init(lcd_fw050_init);
module_exit(lcd_fw050_exit);

MODULE_DESCRIPTION("Ingenic Soc fw050_lcd driver");
MODULE_LICENSE("GPL");