#include <linux/delay.h>
#include <linux/gpio.h>
#include <linux/module.h>
#include <utils/gpio.h>

#include <fb/lcdc_data.h>
#include <mipi_dsi/jz_mipi_dsi.h>

int gpio_lcd_power_en = -1;     // GPIO_PB(19)
int gpio_lcd_rst = -1;          // GPIO_PB(23)
int gpio_lcd_backlight_en = -1; // -1

module_param_gpio(gpio_lcd_power_en, 0644);
module_param_gpio(gpio_lcd_rst, 0644);
module_param_gpio(gpio_lcd_backlight_en, 0644);

static struct dsi_cmd_packet otm8018b_cmd_list[] =
{
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x00}},
    {0x39, 0x04, 0x00, (uint8_t[]){0xFF,0x80,0x09,0x01}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x80}},
    {0x39, 0x03, 0x00, (uint8_t[]){0xFF,0x80,0x09}},
    {0x39, 0x04, 0x00, (uint8_t[]){0x00,0xD2,0xD2,0xD2}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xB0,0x01}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x80}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC4,0x30}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x8A}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC4,0x40}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x8B}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xB0,0x40}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xA6}},
    {0x39, 0x03, 0x00, (uint8_t[]){0xB3,0x20,0x01}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x90}},
    {0x39, 0x07, 0x00, (uint8_t[]){0xC0,0x00,0x44,0x00,0x00,0x00,0x03}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xB4}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC0,0x50}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x81}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC1,0x66}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xA0}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC1,0x02}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xA6}},
    {0x39, 0x04, 0x00, (uint8_t[]){0xC1,0x01,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x81}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC4,0x81}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x87}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC4,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x89}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC4,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x82}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC5,0x83}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x90}},
    {0x39, 0x08, 0x00, (uint8_t[]){0xC5,0x96,0x34,0x06,0x91,0x33,0x34,0x23}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xB1}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC5,0xA8}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xC0}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC5,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x00}},
    {0x39, 0x03, 0x00, (uint8_t[]){0xD8,0x6F,0x6F}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xD9,0x56}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xB2}},
    {0x39, 0x05, 0x00, (uint8_t[]){0xF5,0x15,0x00,0x15,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x80}},
    {0x39, 0x0d, 0x00, (uint8_t[]){0xCE,0x86,0x01,0x00,0x85,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xA0}},
    {0x39, 0x0f, 0x00, (uint8_t[]){0xCE,0x18,0x05,0x83,0x39,0x00,0x00,0x00,0x18,0x04,0x83,0x3A,0x00,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xB0}},
    {0x39, 0x0f, 0x00, (uint8_t[]){0xCE,0x18,0x03,0x83,0x3B,0x86,0x00,0x00,0x18,0x02,0x83,0x3C,0x88,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xC0}},
    {0x39, 0x0b, 0x00, (uint8_t[]){0xCF,0x01,0x01,0x20,0x20,0x00,0x00,0x01,0x02,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xD0}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xCF,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xC0}},
    {0x39, 0x16, 0x00, (uint8_t[]){0xCB,0x00,0x04,0x04,0x04,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xD0}},
    {0x39, 0x16, 0x00, (uint8_t[]){0xCB,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x04,0x04,0x04,0x04,0x00,0x00,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xE0}},
    {0x39, 0x0b, 0x00, (uint8_t[]){0xCB,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x80}},
    {0x39, 0x0b, 0x00, (uint8_t[]){0xCC,0x00,0x26,0x09,0x0B,0x01,0x25,0x00,0x00,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x90}},
    {0x39, 0x10, 0x00, (uint8_t[]){0xCC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x26,0x0A,0x0C,0x02}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xA0}},
    {0x39, 0x10, 0x00, (uint8_t[]){0xCC,0x25,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xB0}},
    {0x39, 0x0b, 0x00, (uint8_t[]){0xCC,0x00,0x25,0x0C,0x0A,0x02,0x26,0x00,0x00,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xC0}},
    {0x39, 0x10, 0x00, (uint8_t[]){0xCC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x25,0x0B,0x09,0x01}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xD0}},
    {0x39, 0x10, 0x00, (uint8_t[]){0xCC,0x26,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x00}},
    {0x39, 0x11, 0x00, (uint8_t[]){0xE1,0x00,0x08,0x0D,0x0D,0x06,0x0E,0x0B,0x0A,0x03,0x07,0x0D,0x08,0x0F,0x14,0x0D,0x03}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x00}},
    {0x39, 0x11, 0x00, (uint8_t[]){0xE2,0x00,0x08,0x0E,0x0E,0x07,0x0E,0x0B,0x0A,0x03,0x07,0x0E,0x08,0x0F,0x14,0x0D,0x03}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xA0}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC1,0xEA}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xA6}},
    {0x39, 0x04, 0x00, (uint8_t[]){0xC1,0x01,0x00,0x00}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xC6}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xB0,0x03}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x81}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xC5,0x66}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xB6}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xF5,0x06}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x8B}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xB0,0x40}},
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0xB1}},
    {0x39, 0x02, 0x00, (uint8_t[]){0xB0,0x80}}, //MIPI RC delay setting
    {0x39, 0x02, 0x00, (uint8_t[]){0x00,0x00}},
    {0x39, 0x04, 0x00, (uint8_t[]){0xFF,0xFF,0xFF,0xFF}},
	// {5, {CMD_DELAY}, MIPI_GENERIC_LONG_WRITE},		/* Delay 120ms */
	{0x39, 0x02, 0x00, (uint8_t[]){0x36,0x00}},
	{0x39, 0x02, 0x00, (uint8_t[]){0x3A,0x77}},
};

static void otm8018b_init(void)
{
    int i;

    struct dsi_cmd_packet otm8018b_sleep_out = {0x05, 0x11, 0x00};
    struct dsi_cmd_packet otm8018b_display_on = {0x05, 0x29, 0x00};

    for (i = 0; i < ARRAY_SIZE(otm8018b_cmd_list); i++) {
        dsi_write_cmd(&otm8018b_cmd_list[i]);
    }

    dsi_write_cmd(&otm8018b_sleep_out);
    msleep(120);
    dsi_write_cmd(&otm8018b_display_on);
    msleep(5);
}

static inline int m_gpio_request(int gpio, const char *name)
{
    if (gpio < 0)
        return 0;

    int ret = gpio_request(gpio, name);
    if (ret) {
        char buf[20];
        printk(KERN_ERR "ma0060: failed to request %s: %s\n", name, gpio_to_str(gpio, buf));
        return ret;
    }

    return 0;
}

static inline void m_gpio_free(int gpio)
{
    if (gpio >= 0)
        gpio_free(gpio);
}

static inline void m_gpio_direction_output(int gpio, int value)
{
    if (gpio >= 0) {
        gpio_direction_output(gpio, value);
    }
}

static int otm8018b_power_on(struct lcdc *lcdc)
{
    m_gpio_direction_output(gpio_lcd_power_en, 1);
    m_gpio_direction_output(gpio_lcd_backlight_en, 1);
    msleep(20);
    m_gpio_direction_output(gpio_lcd_rst, 1);
    msleep(30);
    m_gpio_direction_output(gpio_lcd_rst, 0);
    msleep(30);
    m_gpio_direction_output(gpio_lcd_rst, 1);
    msleep(30);

    return 0;
}

static int otm8018b_power_off(struct lcdc *lcdc)
{
    m_gpio_direction_output(gpio_lcd_power_en, 0);

    m_gpio_direction_output(gpio_lcd_backlight_en, 0);

    return 0;
}

static struct lcdc_data lcdc_data = {
    .name = "otm8018b",
    .refresh = 60,
    .xres = 480,
    .yres = 800,
    .pixclock = 0,
    .left_margin = 50,
    .right_margin = 46,
    .upper_margin = 21,
    .lower_margin = 15,
    .hsync_len = 5,
    .vsync_len = 5,

    .fb_fmt = fb_fmt_ARGB8888,
    .lcd_mode = TFT_MIPI,
    .out_format = OUT_FORMAT_RGB888,

    .mipi = {
        .num_of_lanes = 2,
        .virtual_channel = 0,
        .color_coding = COLOR_CODE_24BIT,
        .data_en_polarity = AT_RISING_EDGE,
        .byte_clock = 0,
        .max_hs_to_lp_cycles = 100,
        .max_lp_to_hs_cycles = 40,
        .max_bta_cycles = 4095,
        .color_mode_polarity = AT_RISING_EDGE,
        .shut_down_polarity = AT_RISING_EDGE,
        .video_mode = VIDEO_BURST_WITH_SYNC_PULSES,

        .hsync_active_level = AT_HIGH_LEVEL,
        .vsync_active_level = AT_HIGH_LEVEL,
    },
    .height = 86,
    .width = 53,

    .power_on = otm8018b_power_on,
    .power_off = otm8018b_power_off,
    .lcd_init = otm8018b_init,
};

static int lcd_otm8018b_init(void)
{
    int ret;

    ret = m_gpio_request(gpio_lcd_power_en, "gpio_lcd_power_en");
    if(ret)
        return -1;

    ret = m_gpio_request(gpio_lcd_rst, "gpio_lcd_rst");
    if (ret)
        goto rst_err;

    ret = m_gpio_request(gpio_lcd_backlight_en, "gpio_lcd_backlight_en");
    if(ret)
        goto backlight_err;

    ret = jzfb_register_lcd(&lcdc_data);
    if (ret < 0) {
        goto register_err;
    }

    return 0;

register_err:
    gpio_free(gpio_lcd_backlight_en);
backlight_err:
    gpio_free(gpio_lcd_rst);
rst_err:
    gpio_free(gpio_lcd_power_en);
    return -1;
}


static void lcd_otm8018b_exit(void)
{
    jzfb_unregister_lcd(&lcdc_data);

    m_gpio_free(gpio_lcd_backlight_en);
    m_gpio_free(gpio_lcd_rst);
    m_gpio_free(gpio_lcd_power_en);
}

module_init(lcd_otm8018b_init);
module_exit(lcd_otm8018b_exit);

MODULE_DESCRIPTION("Ingenic Soc otm8018b_lcd driver");
MODULE_LICENSE("GPL");
